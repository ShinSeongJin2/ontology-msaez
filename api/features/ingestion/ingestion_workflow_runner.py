"""
Ingestion Workflow Runner (streaming)

Business capability: convert uploaded requirements text into an Event Storming model in Neo4j,
emitting real-time progress events for the UI (SSE).
"""

from __future__ import annotations

from typing import AsyncGenerator

from api.features.ingestion.ingestion_contracts import IngestionPhase, ProgressEvent
from api.features.ingestion.ingestion_llm_runtime import get_llm
from api.features.ingestion.ingestion_sessions import IngestionSession
from api.features.ingestion.workflow.ingestion_workflow_context import IngestionWorkflowContext
from api.features.ingestion.workflow.phases.aggregates import extract_aggregates_phase
from api.features.ingestion.workflow.phases.bounded_contexts import identify_bounded_contexts_phase
from api.features.ingestion.workflow.phases.commands import extract_commands_phase
from api.features.ingestion.workflow.phases.events import extract_events_phase
from api.features.ingestion.workflow.phases.parsing import parsing_phase
from api.features.ingestion.workflow.phases.policies import identify_policies_phase
from api.features.ingestion.workflow.phases.user_stories import extract_user_stories_phase
from api.platform.observability.smart_logger import SmartLogger


async def run_ingestion_workflow(session: IngestionSession, content: str) -> AsyncGenerator[ProgressEvent, None]:
    """
    Run the full ingestion workflow with streaming progress updates.
    """
    from api.features.ingestion.event_storming.neo4j_client import get_neo4j_client

    client = get_neo4j_client()
    llm = get_llm()
    ctx = IngestionWorkflowContext(session=session, content=content, client=client, llm=llm)

    try:
        SmartLogger.log(
            "INFO",
            "Ingestion workflow started",
            category="ingestion.workflow",
            params={"session_id": session.id, "content_length": len(content)},
        )

        async for event in parsing_phase(ctx):
            yield event

        async for event in extract_user_stories_phase(ctx):
            yield event

        async for event in identify_bounded_contexts_phase(ctx):
            yield event

        async for event in extract_aggregates_phase(ctx):
            yield event

        async for event in extract_commands_phase(ctx):
            yield event

        async for event in extract_events_phase(ctx):
            yield event

        async for event in identify_policies_phase(ctx):
            yield event

        yield ProgressEvent(
            phase=IngestionPhase.COMPLETE,
            message="✅ 모델 생성 완료!",
            progress=100,
            data={
                "summary": {
                    "user_stories": len(ctx.user_stories),
                    "bounded_contexts": len(ctx.bounded_contexts),
                    "aggregates": sum(len(aggs) for aggs in ctx.aggregates_by_bc.values()),
                    "commands": sum(len(cmds) for cmds in ctx.commands_by_agg.values()),
                    "events": sum(len(evts) for evts in ctx.events_by_agg.values()),
                    "policies": len(ctx.policies),
                }
            },
        )
        SmartLogger.log(
            "INFO",
            "Ingestion workflow complete",
            category="ingestion.workflow",
            params={
                "session_id": session.id,
                "user_stories": len(ctx.user_stories),
                "bounded_contexts": len(ctx.bounded_contexts),
                "aggregates": sum(len(aggs) for aggs in ctx.aggregates_by_bc.values()),
                "commands": sum(len(cmds) for cmds in ctx.commands_by_agg.values()),
                "events": sum(len(evts) for evts in ctx.events_by_agg.values()),
                "policies": len(ctx.policies),
            },
        )

    except Exception as e:
        SmartLogger.log(
            "ERROR",
            "Ingestion workflow failed",
            category="ingestion.workflow",
            params={"session_id": session.id, "error": str(e)},
        )
        yield ProgressEvent(phase=IngestionPhase.ERROR, message=f"❌ 오류 발생: {str(e)}", progress=0, data={"error": str(e)})


